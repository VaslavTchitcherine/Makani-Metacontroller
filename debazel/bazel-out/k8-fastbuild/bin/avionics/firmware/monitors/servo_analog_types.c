#include "avionics/firmware/monitors/servo_analog_types.h"

#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>

#include "avionics/firmware/monitors/analog_types.h"
#include "avionics/firmware/serial/servo_serial_params.h"

static const AnalogMonitor kDeviceRevAa[9] = {
  [0] = {
    .input = kServoAnalogInputHiltDetect,
    .voltage = kServoAnalogVoltageForceSigned,
    .type = kAnalogTypeLogicLow,
    .channel = 14,
    .volts_per_count = 0.0f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [1] = {
    .input = kServoAnalogInputIServo,
    .voltage = kServoAnalogVoltageIServo,
    .type = kAnalogTypeVoltage,
    .channel = 9,
    .volts_per_count = 0.01220703125f,
    .offset = 25.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 10.0f},
  [2] = {
    .input = kServoAnalogInputLvA,
    .voltage = kServoAnalogVoltageLvA,
    .type = kAnalogTypeVoltage,
    .channel = 6,
    .volts_per_count = 0.029296875f,
    .offset = 0.0f,
    .nominal = 75.0f,
    .min = 55.0f,
    .max = 77.0f},
  [3] = {
    .input = kServoAnalogInputLvB,
    .voltage = kServoAnalogVoltageLvB,
    .type = kAnalogTypeVoltage,
    .channel = 7,
    .volts_per_count = 0.029296875f,
    .offset = 0.0f,
    .nominal = 75.0f,
    .min = 55.0f,
    .max = 77.0f},
  [4] = {
    .input = kServoAnalogInputPortDetect0,
    .voltage = kServoAnalogVoltageForceSigned,
    .type = kAnalogTypePortDetect,
    .channel = 10,
    .volts_per_count = 0.0f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [5] = {
    .input = kServoAnalogInputPortDetect1,
    .voltage = kServoAnalogVoltageForceSigned,
    .type = kAnalogTypePortDetect,
    .channel = 11,
    .volts_per_count = 0.0f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [6] = {
    .input = kServoAnalogInputPortDetect2,
    .voltage = kServoAnalogVoltageForceSigned,
    .type = kAnalogTypePortDetect,
    .channel = 12,
    .volts_per_count = 0.0f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [7] = {
    .input = kServoAnalogInputPortDetect3,
    .voltage = kServoAnalogVoltageForceSigned,
    .type = kAnalogTypePortDetect,
    .channel = 13,
    .volts_per_count = 0.0f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [8] = {
    .input = kServoAnalogInputVServo,
    .voltage = kServoAnalogVoltageVServo,
    .type = kAnalogTypeVoltage,
    .channel = 8,
    .volts_per_count = 0.029296875f,
    .offset = 0.0f,
    .nominal = 70.0f,
    .min = 50.0f,
    .max = 85.0f},
};

static const AnalogMonitor kDeviceRevBa[8] = {
  [0] = {
    .input = kServoAnalogInput12v,
    .voltage = kServoAnalogVoltage12v,
    .type = kAnalogTypeVoltage,
    .channel = 18,
    .volts_per_count = 0.00388941271552f,
    .offset = 0.0f,
    .nominal = 12.0f,
    .min = 11.4f,
    .max = 12.6f},
  [1] = {
    .input = kServoAnalogInput5v,
    .voltage = kServoAnalogVoltage5v,
    .type = kAnalogTypeVoltage,
    .channel = 19,
    .volts_per_count = 0.00388941271552f,
    .offset = 0.0f,
    .nominal = 5.0f,
    .min = 4.75f,
    .max = 5.25f},
  [2] = {
    .input = kServoAnalogInputClampResistor,
    .voltage = kServoAnalogVoltageClampResistor,
    .type = kAnalogTypeVoltage,
    .channel = 20,
    .volts_per_count = 0.000732421875f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [3] = {
    .input = kServoAnalogInputIServo,
    .voltage = kServoAnalogVoltageIServo,
    .type = kAnalogTypeVoltage,
    .channel = 17,
    .volts_per_count = 0.00554865056818f,
    .offset = 2.70454545455f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 10.0f},
  [4] = {
    .input = kServoAnalogInputLvA,
    .voltage = kServoAnalogVoltageLvA,
    .type = kAnalogTypeVoltage,
    .channel = 14,
    .volts_per_count = 0.0364013671875f,
    .offset = 0.0f,
    .nominal = 75.0f,
    .min = 55.0f,
    .max = 77.0f},
  [5] = {
    .input = kServoAnalogInputLvB,
    .voltage = kServoAnalogVoltageLvB,
    .type = kAnalogTypeVoltage,
    .channel = 15,
    .volts_per_count = 0.0364013671875f,
    .offset = 0.0f,
    .nominal = 75.0f,
    .min = 55.0f,
    .max = 77.0f},
  [6] = {
    .input = kServoAnalogInputPortDetect4,
    .voltage = kServoAnalogVoltageForceSigned,
    .type = kAnalogTypePortDetect,
    .channel = 21,
    .volts_per_count = 0.0f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [7] = {
    .input = kServoAnalogInputVServo,
    .voltage = kServoAnalogVoltageVServo,
    .type = kAnalogTypeVoltage,
    .channel = 16,
    .volts_per_count = 0.0364013671875f,
    .offset = 0.0f,
    .nominal = 70.0f,
    .min = 50.0f,
    .max = 85.0f},
};

static const AnalogMonitor kDeviceRevBb[7] = {
  [0] = {
    .input = kServoAnalogInput12v,
    .voltage = kServoAnalogVoltage12v,
    .type = kAnalogTypeVoltage,
    .channel = 18,
    .volts_per_count = 0.00388941271552f,
    .offset = 0.0f,
    .nominal = 12.0f,
    .min = 11.4f,
    .max = 12.6f},
  [1] = {
    .input = kServoAnalogInput5v,
    .voltage = kServoAnalogVoltage5v,
    .type = kAnalogTypeVoltage,
    .channel = 19,
    .volts_per_count = 0.00388941271552f,
    .offset = 0.0f,
    .nominal = 5.0f,
    .min = 4.75f,
    .max = 5.25f},
  [2] = {
    .input = kServoAnalogInputClampResistor,
    .voltage = kServoAnalogVoltageClampResistor,
    .type = kAnalogTypeVoltage,
    .channel = 20,
    .volts_per_count = 0.000732421875f,
    .offset = 0.0f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 0.0f},
  [3] = {
    .input = kServoAnalogInputIServo,
    .voltage = kServoAnalogVoltageIServo,
    .type = kAnalogTypeVoltage,
    .channel = 17,
    .volts_per_count = 0.00554865056818f,
    .offset = 2.70454545455f,
    .nominal = 0.0f,
    .min = 0.0f,
    .max = 10.0f},
  [4] = {
    .input = kServoAnalogInputLvA,
    .voltage = kServoAnalogVoltageLvA,
    .type = kAnalogTypeVoltage,
    .channel = 14,
    .volts_per_count = 0.0364013671875f,
    .offset = 0.0f,
    .nominal = 75.0f,
    .min = 55.0f,
    .max = 77.0f},
  [5] = {
    .input = kServoAnalogInputLvB,
    .voltage = kServoAnalogVoltageLvB,
    .type = kAnalogTypeVoltage,
    .channel = 15,
    .volts_per_count = 0.0364013671875f,
    .offset = 0.0f,
    .nominal = 75.0f,
    .min = 55.0f,
    .max = 77.0f},
  [6] = {
    .input = kServoAnalogInputVServo,
    .voltage = kServoAnalogVoltageVServo,
    .type = kAnalogTypeVoltage,
    .channel = 16,
    .volts_per_count = 0.0364013671875f,
    .offset = 0.0f,
    .nominal = 70.0f,
    .min = 50.0f,
    .max = 85.0f},
};

static const AnalogMonitors kRevisionMap[4] = {
  [kServoHardwareRevAa] = {
    .channel_mask = 0x00007FC0,
    .populated = 0x000001FF,
    .device = kDeviceRevAa,
    .num_devices = 9},
  [kServoHardwareRevBa] = {
    .channel_mask = 0x003FC000,
    .populated = 0x000000FF,
    .device = kDeviceRevBa,
    .num_devices = 8},
  [kServoHardwareRevBb] = {
    .channel_mask = 0x001FC000,
    .populated = 0x0000007F,
    .device = kDeviceRevBb,
    .num_devices = 7},
  [kServoHardwareRevBc] = {
    .channel_mask = 0x001FC000,
    .populated = 0x0000007F,
    .device = kDeviceRevBb,
    .num_devices = 7},
};

const AnalogMonitors *ServoAnalogGetConfig(ServoHardware servo_hardware) {
  // Avoid "always true" compiler warnings.
  int32_t i_servo_hardware = (int32_t)servo_hardware;
  if (0 <= i_servo_hardware && i_servo_hardware <= 3) {
    return &kRevisionMap[i_servo_hardware];
  }
  return NULL;
}
