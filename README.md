
Makani Metacontoller
"Quis custodiet ipsos custodes?"

We bought Makani's wind kite dyno rig at their going-out-of-business auction, including 16 Yasa/Makani axial flux motors and contollers.

Makani open-sourced all their software, including motor firmware and control software:
	https://github.com/google/makani

The Makani avionics I/O network is described here:
	https://storage.googleapis.com/x-prod.appspot.com/files/Makani_TheEnergyKiteReport_Part2.pdf
(I'd tell a joke here about UDP, but not everyone would get it.)

And I posted a motor controller teardown:
	https://endless-sphere.com/forums/viewtopic.php?f=30&t=108154

Yes, the gigantic pile of Makani code does build and run, but I wanted a standalone way of controlling speed setpoint on simple and cheap hardware, to be able to reuse the motors in various vehicle applications. 

This git contains a small subset of the Makani build, containing only the code needed by the motor_client.py script.  Most of this is code from the Makani git repository.  The subdir lib contains .so dynamic libraries needed by the python code, ELF x86-64 format.  (Scripts for building these libraries were generated by by parsing the verbose output of the massive bazel build, then the scripts were executed to build the libraries.  These build scripts are in the debazel/buildcmds subdir.)

Instead of trying to port motor_client.py to ARMv7, I instrumented low-level _SendInternal() in aio.py to dump the hex being sent out (as mulitcast UDP) on the AIO network.  This output can then be replayed using the trivial script replay.py, which runs successfully on a Pi, without requiring any additional libraries or python packages.
It also works on any architecture (with the correct endian-ness).
The Runner() thread in motor_client.py broadcasts the desired state messages at 100 Hz.
Here's how to replay the commands captured from a run of motor_client.py:
	replay.py < replays/spinup

Here is a video of the motor spinning, with a Pruis hall effect accelerator
pedal connected to the A/D converter on the Pi 3B running the throttle.py script:
	http://rp.to/z1ohz
The throttle.py script simply stuffs omega setpoints into the final 175 char line that is being replayed,
to dynamically control the motor speed:
	throttle.py --init=replays/init

The metacontroller box in the video also contains a 12 to 60 VDC boost converter to power the Makani controller and a Fiberfin POF to ethernet media converter (https://fiberfin.com/product/ff-mce300t-229).
Design files for the simple A/D converter Pi hat are in the adc subdir.

Note that the replay.py and throttle.py scripts assume we are talking to the motor called PTI by Makani, which is at 192.168.1.16.  Using the "program" executable from the full Makani bazel build you can run:
	program motor_pti
to program your motor at 192.168.1.16 with the settings in network.yaml.

Many thanks to ex-Makani engineer Johnny Sun <jsun9679@gmail.com> who provided many clues that helped me understand how to get these motors spinning.
